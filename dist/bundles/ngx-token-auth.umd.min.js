!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("@angular/common/http"),require("rxjs/Observable"),require("rxjs/add/operator/share"),require("rxjs/add/observable/interval"),require("rxjs/add/observable/fromEvent"),require("rxjs/add/operator/pluck"),require("rxjs/add/operator/filter")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/router","@angular/common/http","rxjs/Observable","rxjs/add/operator/share","rxjs/add/observable/interval","rxjs/add/observable/fromEvent","rxjs/add/operator/pluck","rxjs/add/operator/filter"],e):e(t["ngx-token-auth"]={},t.ng.core,t.ng.router,t.ng.common.http,t.Rx)}(this,function(t,e,r,n,a){"use strict";var o=new e.InjectionToken("AUTH_TOKEN_OPTIONS"),s=this&&this.__decorate||function(t,e,r,n){var a,o=arguments.length,s=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var i=t.length-1;i>=0;i--)(a=t[i])&&(s=(o<3?a(s):o>3?a(e,r,s):a(e,r))||s);return o>3&&s&&Object.defineProperty(e,r,s),s},i=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},u=this&&this.__param||function(t,e){return function(r,n){e(r,n,t)}};t.AuthTokenService=function(){function t(t,e,r,n){this.http=t,this.activatedRoute=r,this.router=n,this.defaultOptions={apiPath:null,apiBase:null,signInPath:"auth/sign_in",signInRedirect:null,signInStoredUrlStorageKey:null,signOutPath:"auth/sign_out",validateTokenPath:"auth/validate_token",signOutFailedValidate:!1,registerAccountPath:"auth",deleteAccountPath:"auth",registerAccountCallback:window.location.href,updatePasswordPath:"auth",resetPasswordPath:"auth/password",resetPasswordCallback:window.location.href,userTypes:null,oAuthBase:window.location.origin,oAuthPaths:{github:"auth/github"},oAuthCallbackPath:"oauth_callback",oAuthWindowType:"newWindow",oAuthWindowOptions:null,globalOptions:{headers:{"Content-Type":"application/json",Accept:"application/json"}}},e&&(this.atOptions=Object.assign(this.defaultOptions,e))}return Object.defineProperty(t.prototype,"currentUserType",{get:function(){return null!=this.atCurrentUserType?this.atCurrentUserType.name:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentUserData",{get:function(){return this.atCurrentUserData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAuthData",{get:function(){return this.atCurrentAuthData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAuthHeaders",{get:function(){return null!=this.atCurrentAuthData?new n.HttpHeaders({"access-token":this.atCurrentAuthData.accessToken,client:this.atCurrentAuthData.client,expiry:this.atCurrentAuthData.expiry,"token-type":this.atCurrentAuthData.tokenType,uid:this.atCurrentAuthData.uid}):new n.HttpHeaders},enumerable:!0,configurable:!0}),t.prototype.userSignedIn=function(){return!!this.atCurrentAuthData},t.prototype.canActivate=function(){return!!this.userSignedIn()||(this.atOptions.signInStoredUrlStorageKey&&localStorage.setItem(this.atOptions.signInStoredUrlStorageKey,window.location.pathname+window.location.search),this.router&&this.atOptions.signInRedirect&&this.router.navigate([this.atOptions.signInRedirect]),!1)},t.prototype.init=function(t){this.atOptions=Object.assign(this.defaultOptions,t),this.tryLoadAuthData()},t.prototype.registerAccount=function(t){return null==t.userType?this.atCurrentUserType=null:(this.atCurrentUserType=this.getUserTypeByName(t.userType),delete t.userType),t.password_confirmation=t.passwordConfirmation,delete t.passwordConfirmation,t.confirm_success_url=this.atOptions.registerAccountCallback,this.post(this.getUserPath()+this.atOptions.registerAccountPath,JSON.stringify(t))},t.prototype.deleteAccount=function(){return this["delete"](this.getUserPath()+this.atOptions.deleteAccountPath)},t.prototype.signIn=function(t){var e=this;null==t.userType?this.atCurrentUserType=null:this.atCurrentUserType=this.getUserTypeByName(t.userType);var r=JSON.stringify({email:t.email,password:t.password}),n=this.post(this.getUserPath()+this.atOptions.signInPath,r);return n.subscribe(function(t){return e.atCurrentUserData=t.json().data},function(t){return null}),n},t.prototype.signInOAuth=function(t){var e=this.getOAuthPath(t),r=this.atOptions.oAuthWindowType,n=this.getOAuthUrl(e,"${window.location.origin}/${this.atOptions.oAuthCallbackPath}",r);if("newWindow"===r){this.atOptions.oAuthWindowOptions;var a=window.open(n,"_blank","closebuttoncaption=Cancel${windowOptions}");return this.requestCredentialsViaPostMessage(a)}if("sameWindow"!==r)throw'Unsupported oAuthWindowType "${oAuthWindowType}"';window.location.href=n},t.prototype.processOAuthCallback=function(){this.getAuthDataFromParams()},t.prototype.signOut=function(){var t=this["delete"](this.getUserPath()+this.atOptions.signOutPath);return localStorage.removeItem("accessToken"),localStorage.removeItem("client"),localStorage.removeItem("expiry"),localStorage.removeItem("tokenType"),localStorage.removeItem("uid"),this.atCurrentAuthData=null,this.atCurrentUserType=null,this.atCurrentUserData=null,t},t.prototype.validateToken=function(){var t=this,e=this.get(this.getUserPath()+this.atOptions.validateTokenPath);return e.subscribe(function(e){return t.atCurrentUserData=e.json().data},function(e){401===e.status&&t.atOptions.signOutFailedValidate&&t.signOut()}),e},t.prototype.updatePassword=function(t){null!=t.userType&&(this.atCurrentUserType=this.getUserTypeByName(t.userType));var e;e=null==t.passwordCurrent?{password:t.password,password_confirmation:t.passwordConfirmation}:{current_password:t.passwordCurrent,password:t.password,password_confirmation:t.passwordConfirmation},t.resetPasswordToken&&(e.reset_password_token=t.resetPasswordToken);var r=JSON.stringify(e);return this.put(this.getUserPath()+this.atOptions.updatePasswordPath,r)},t.prototype.resetPassword=function(t){null==t.userType?this.atCurrentUserType=null:this.atCurrentUserType=this.getUserTypeByName(t.userType);var e=JSON.stringify({email:t.email,redirect_url:this.atOptions.resetPasswordCallback});return this.post(this.getUserPath()+this.atOptions.resetPasswordPath,e)},t.prototype.get=function(t,e){var r=this.http.get(this.getApiPath()+t,e).share();return this.handleResponse(r),r},t.prototype.post=function(t,e,r){var n=this.http.post(this.getApiPath()+t,e,r).share();return this.handleResponse(n),n},t.prototype.put=function(t,e,r){var n=this.http.put(this.getApiPath()+t,e,r).share();return this.handleResponse(n),n},t.prototype["delete"]=function(t,e){var r=this.http["delete"](this.getApiPath()+t,e).share();return this.handleResponse(r),r},t.prototype.patch=function(t,e,r){var n=this.http.patch(this.getApiPath()+t,e,r).share();return this.handleResponse(n),n},t.prototype.head=function(t,e){var r=this.http.head(this.getApiPath()+t,e).share();return this.handleResponse(r),r},t.prototype.options=function(t,e){var r=this.http.options(this.getApiPath()+t,e).share();return this.handleResponse(r),r},t.prototype.setCurrentAuthHeaders=function(){var t=this;this.getAuthDataFromStorage(),this.getAuthDataFromParams();var e=new n.HttpHeaders;return null!=this.atCurrentAuthData&&(e.append("access-token",this.atCurrentAuthData.accessToken),e.append("client",this.atCurrentAuthData.client),e.append("expiry",this.atCurrentAuthData.expiry),e.append("token-type",this.atCurrentAuthData.tokenType),e.append("uid",this.atCurrentAuthData.uid)),Object.keys(this.atOptions.globalOptions.headers).forEach(function(r){return e.append(r,t.atOptions.globalOptions.headers[r])}),e},t.prototype.handleResponse=function(t){var e=this;t.subscribe(function(t){e.getAuthHeadersFromResponse(t)},function(t){e.getAuthHeadersFromResponse(t)})},t.prototype.tryLoadAuthData=function(){var t=this.getUserTypeByName(localStorage.getItem("userType"));t&&(this.atCurrentUserType=t),this.getAuthDataFromStorage(),this.activatedRoute&&this.getAuthDataFromParams(),this.atCurrentAuthData&&this.validateToken()},t.prototype.getAuthHeadersFromResponse=function(t){var e=t.headers,r={accessToken:e.get("access-token"),client:e.get("client"),expiry:e.get("expiry"),tokenType:e.get("token-type"),uid:e.get("uid")};this.setAuthData(r)},t.prototype.getAuthDataFromPostMessage=function(t){var e={accessToken:t.auth_token,client:t.client_id,expiry:t.expiry,tokenType:"Bearer",uid:t.uid};this.setAuthData(e)},t.prototype.getAuthDataFromStorage=function(){var t={accessToken:localStorage.getItem("accessToken"),client:localStorage.getItem("client"),expiry:localStorage.getItem("expiry"),tokenType:localStorage.getItem("tokenType"),uid:localStorage.getItem("uid")};this.checkAuthData(t)&&(this.atCurrentAuthData=t)},t.prototype.getAuthDataFromParams=function(){var t=this;this.activatedRoute.queryParams&&this.activatedRoute.queryParams.subscribe(function(e){var r={accessToken:e.token||e.auth_token,client:e.client_id,expiry:e.expiry,tokenType:"Bearer",uid:e.uid};t.checkAuthData(r)&&(t.atCurrentAuthData=r)})},t.prototype.setAuthData=function(t){this.checkAuthData(t)&&(this.atCurrentAuthData=t,localStorage.setItem("accessToken",t.accessToken),localStorage.setItem("client",t.client),localStorage.setItem("expiry",t.expiry),localStorage.setItem("tokenType",t.tokenType),localStorage.setItem("uid",t.uid),null!=this.atCurrentUserType&&localStorage.setItem("userType",this.atCurrentUserType.name))},t.prototype.checkAuthData=function(t){return null!=t.accessToken&&null!=t.client&&null!=t.expiry&&null!=t.tokenType&&null!=t.uid&&(null==this.atCurrentAuthData||t.expiry>=this.atCurrentAuthData.expiry)},t.prototype.getUserPath=function(){return null==this.atCurrentUserType?"":this.atCurrentUserType.path+"/"},t.prototype.getApiPath=function(){var t="";return null!=this.atOptions.apiBase&&(t+=this.atOptions.apiBase+"/"),null!=this.atOptions.apiPath&&(t+=this.atOptions.apiPath+"/"),t},t.prototype.getOAuthPath=function(t){var e;return null==(e=this.atOptions.oAuthPaths[t])&&(e="/auth/${oAuthType}"),e},t.prototype.getOAuthUrl=function(t,e,r){var n;return n="${this.atOptions.oAuthBase}/${oAuthPath}",n+="?omniauth_window_type=${windowType}",n+="&auth_origin_url=${encodeURIComponent(callbackUrl)}",null!=this.atCurrentUserType&&(n+="&resource_class=${this.atCurrentUserType.name}"),n},t.prototype.requestCredentialsViaPostMessage=function(t){var e=a.Observable.interval(500),r=a.Observable.fromEvent(window,"message").pluck("data").filter(this.oAuthWindowResponseFilter),n=(r.subscribe(this.getAuthDataFromPostMessage.bind(this)),e.subscribe(function(){t.closed?n.unsubscribe():t.postMessage("requestCredentials","*")}));return r},t.prototype.oAuthWindowResponseFilter=function(t){if("deliverCredentials"===t.message||"authFailure"===t.message)return t},t.prototype.getUserTypeByName=function(t){return null==t||null==this.atOptions.userTypes?null:this.atOptions.userTypes.find(function(e){return e.name===t})},t}(),t.AuthTokenService=s([e.Injectable(),u(0,e.Inject(n.HttpClient)),u(1,e.Inject(o)),u(2,e.Optional()),u(2,e.Inject(r.ActivatedRoute)),u(3,e.Optional()),u(3,e.Inject(r.Router)),i("design:paramtypes",[n.HttpClient,Object,r.ActivatedRoute,r.Router])],t.AuthTokenService);var h=this&&this.__decorate||function(t,e,r,n){var a,o=arguments.length,s=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var i=t.length-1;i>=0;i--)(a=t[i])&&(s=(o<3?a(s):o>3?a(e,r,s):a(e,r))||s);return o>3&&s&&Object.defineProperty(e,r,s),s},p=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};t.AuthTokenInterceptor=function(){function t(t){this.authTokenService=t}return t.prototype.intercept=function(t,e){this.authTokenService.setCurrentAuthHeaders();var r=this.authTokenService.currentAuthHeaders;r.keys().forEach(function(e){return t.headers.append(e,r.get(e))});var n=t.clone({headers:t.headers});return e.handle(n)},t}(),t.AuthTokenInterceptor=h([e.Injectable(),p("design:paramtypes",[t.AuthTokenService])],t.AuthTokenInterceptor);var c=this&&this.__decorate||function(t,e,r,n){var a,o=arguments.length,s=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var i=t.length-1;i>=0;i--)(a=t[i])&&(s=(o<3?a(s):o>3?a(e,r,s):a(e,r))||s);return o>3&&s&&Object.defineProperty(e,r,s),s},l=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},d=this&&this.__param||function(t,e){return function(r,n){e(r,n,t)}};t.AuthTokenModule=f=function(){function e(t){if(t)throw new Error("AuthTokenModule is already loaded. It should only be imported in your application's main module.")}return e.forRoot=function(e){return{ngModule:f,providers:[{provide:n.HTTP_INTERCEPTORS,useClass:t.AuthTokenInterceptor,multi:!0},e.authTokenOptionsProvider||{provide:o,useValue:e.config},t.AuthTokenService]}},e}(),t.AuthTokenModule=f=c([e.NgModule(),d(0,e.Optional()),d(0,e.SkipSelf()),l("design:paramtypes",[t.AuthTokenModule])],t.AuthTokenModule);var f;t.AUTH_TOKEN_OPTIONS=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-token-auth.umd.min.js.map
